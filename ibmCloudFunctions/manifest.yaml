packages:
  commercetools:
    inputs:
      nameSpace: $SPACE
      cloudFunctionsNamespace: $CLOUD_FUNCTIONS_NAMESPACE
      mongoUri: $MONGO_URI # although the CT Cloud Functions don't store product data in MongoDB, they do rely on MongoDB for logging
      mongoCertificateBase64: $MONGO_CERTIFICATE_BASE64
      dbName: $DB_NAME
      kafkaBrokers: $KAFKA_BROKERS
      kafkaUsername: $KAFKA_USERNAME
      kafkaPassword: $KAFKA_PASSWORD
      kafkaInvalidMessagesDlqTopicName: $KAFKA_INVALID_MESSAGES_DLQ_TOPIC_NAME
      messagesMongoUri: $MESSAGES_MONGO_URI
      messagesMongoCertificateBase64: $MESSAGES_MONGO_CERTIFICATE_BASE64
      cloudFunctionsRestEndpoint: $CLOUD_FUNCTIONS_REST_ENDPOINT
      cloudFunctionsRestUsername: $CLOUD_FUNCTIONS_REST_USERNAME
      cloudFunctionsRestPassword: $CLOUD_FUNCTIONS_REST_PASSWORD
      ctpProjectKey: $CTP_PROJECT_KEY
      ctpClientId: $CTP_CLIENT_ID
      ctpClientSecret: $CTP_CLIENT_SECRET
      ctpAuthUrl: $CTP_AUTH_URL
      ctpApiUrl: $CTP_API_URL
      ctpScopes: $CTP_SCOPES # see https://docs.commercetools.com/http-api-scopes
      productTypeId: $PRODUCT_TYPE_ID # reference to the Product Type on CT
    actions:
      consume-catalog-message-ct:
        location: ./commercetools/consumeCatalogMessageCT/dist/bundle.js
        runtime: nodejs:10
        limits:
          memorySize: 512
          timeout: 600000
        inputs:
          topicName: styles-connect-jdbc-CATALOG
      consume-catalog-message-with-retry-ct:
        location: ./commercetools/consumeCatalogMessageWithRetryCT/dist/bundle.js
        conductor: true
        runtime: nodejs:10
        limits:
          memorySize: 512
          timeout: 600000
      consume-sku-message-ct:
        location: ./commercetools/consumeSkuMessageCT/dist/bundle.js
        runtime: nodejs:10
        limits:
          memorySize: 512
          timeout: 600000
        inputs:
          topicName: skus-connect-jdbc
      consume-sku-message-with-retry:
        location: ./commercetools/consumeSkuMessageWithRetryCT/dist/bundle.js
        conductor: true
        runtime: nodejs:10
        limits:
          memorySize: 512
          timeout: 600000
    triggers:
      catalog-ct-trigger:
        feed: /${ORG}_${SPACE}/${FEED_BASE}/messageHubFeed
        inputs:
          isJSONData: true
          topic: styles-connect-jdbc-CATALOG
      sku-ct-trigger:
        feed: /${ORG}_${SPACE}/${FEED_BASE}/messageHubFeed
        inputs:
          isJSONData: true
          topic: skus-connect-jdbc
    rules:
      catalog-rule-ct:
        action: /${ORG}_${SPACE}/commercetools/consume-catalog-message-with-retry-ct
        trigger: catalog-ct-trigger
      sku-rule-ct:
        action: /${ORG}_${SPACE}/commercetools/consume-sku-message-with-retry-ct
        trigger: sku-ct-trigger
